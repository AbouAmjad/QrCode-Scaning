<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Enterprise Tool Intelligence Dashboard</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  body { font-family: Arial, sans-serif; background: #14213d; color: #fff; padding: 20px; }
  table { width: 100%; border-collapse: collapse; margin-top: 20px; }
  th, td { border: 1px solid #555; padding: 8px; text-align: center; }
  th { background: #222; }
  .stats { display: flex; gap: 20px; margin-top: 20px; }
  .stat-card { background: #1d3557; padding: 15px; border-radius: 10px; flex: 1; text-align: center; }
  .filter { margin-top: 20px; }
</style>
</head>
<body>

<h1>Enterprise Tool Intelligence Dashboard</h1>

<div class="filter">
  <label>Filter by Person Code:
    <select id="personFilter">
      <option value="">All</option>
    </select>
  </label>
</div>

<div class="stats">
  <div class="stat-card">Total Items: <span id="totalItems">0</span></div>
  <div class="stat-card">Unique Personnel: <span id="totalPeople">0</span></div>
  <div class="stat-card">Unique Tools: <span id="uniqueTools">0</span></div>
</div>

<div id="results"></div>

<script>
const WEB_APP_URL = "YOUR_GOOGLE_SCRIPT_WEB_APP_URL";

let allData = [];

async function fetchData() {
  const url = new URL(WEB_APP_URL);
  url.searchParams.append('action', 'getAllData');

  try {
    const res = await fetch(url);
    const json = await res.json();

    if (json.error) {
      alert("Error: " + json.error);
      return;
    }

    allData = json.unreturnedTools || [];
    populatePersonFilter(json.uniquePersonCodes || []);
    displayData();
  } catch (err) {
    alert("Network error: " + err.message);
  }
}

function populatePersonFilter(personCodes) {
  const select = document.getElementById('personFilter');
  select.innerHTML = '<option value="">All</option>';
  personCodes.forEach(code => {
    const opt = document.createElement('option');
    opt.value = code;
    opt.textContent = code;
    select.appendChild(opt);
  });
}

function displayData() {
  const filterValue = document.getElementById('personFilter').value;
  let filteredData = allData;

  if (filterValue) {
    filteredData = allData.filter(item => item.personCode === filterValue);
  }

  // Aggregate quantities per person & tool
  const aggregated = {};
  filteredData.forEach(item => {
    const key = item.personCode + '||' + item.toolCode;
    if (!aggregated[key]) {
      aggregated[key] = {...item, count: item.count || 1};
    } else {
      aggregated[key].count += item.count || 1;
    }
  });

  const resultArray = Object.values(aggregated);

  // Update stats
  document.getElementById('totalItems').textContent = resultArray.reduce((sum, i) => sum + i.count, 0);
  document.getElementById('totalPeople').textContent = new Set(resultArray.map(i => i.personCode)).size;
  document.getElementById('uniqueTools').textContent = new Set(resultArray.map(i => i.toolCode)).size;

  // Display table
  if (resultArray.length === 0) {
    document.getElementById('results').innerHTML = "<p>No unreturned tools.</p>";
    return;
  }

  let html = '<table><thead><tr><th>Person Code</th><th>Tool Code</th><th>Tool Description</th><th>Quantity</th></tr></thead><tbody>';
  resultArray.forEach(item => {
    html += `<tr>
      <td>${item.personCode}</td>
      <td>${item.toolCode}</td>
      <td>${item.toolDescription || ''}</td>
      <td>${item.count}</td>
    </tr>`;
  });
  html += '</tbody></table>';
  document.getElementById('results').innerHTML = html;
}

document.getElementById('personFilter').addEventListener('change', displayData);

fetchData();
</script>

</body>
</html>
