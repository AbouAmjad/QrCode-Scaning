<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>QR Scanner</title>

<style>
body {
  background: #111;
  color: #fff;
  font-family: Arial, sans-serif;
  padding: 20px;
}
.container {
  max-width: 900px;
  margin: auto;
  background: #1c1c1c;
  padding: 25px;
  border-radius: 12px;
}
input {
  width: 100%;
  padding: 18px;
  font-size: 18px;
  border-radius: 8px;
  border: none;
  outline: none;
}
button {
  margin-top: 15px;
  width: 100%;
  padding: 18px;
  font-size: 18px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  background: #4caf50;
  color: #000;
  font-weight: bold;
}
.log {
  margin-top: 25px;
  max-height: 400px;
  overflow-y: auto;
}
.log-item {
  background: #2a2a2a;
  margin-bottom: 10px;
  padding: 10px;
  border-radius: 6px;
}
.pending { color: #ffc107; }
.synced { color: #4caf50; }
.offline {
  background: #c62828;
  padding: 8px;
  text-align: center;
  border-radius: 6px;
  display: none;
}
.online {
  background: #2e7d32;
  padding: 8px;
  text-align: center;
  border-radius: 6px;
  display: none;
}
</style>
</head>

<body>

<div class="offline" id="offline">OFFLINE â€” scans saved</div>
<div class="online" id="online">ONLINE â€” syncing scans</div>

<div class="container">
  <h2>QR Scanner</h2>
  <input id="scanInput" placeholder="Scan code here" autofocus>
  <button onclick="submitScan()">Submit Scan</button>
  <div class="log" id="log"></div>
</div>

<script>
/* ===============================
   CONFIG
=============================== */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyrScJh7k84wwIpEAr4MqSrnsyvPBMp3BYhPpM1hPyG_V7RPBPtQ_um3YYcCw0JLmc/exec";
const tokenValue = localStorage.getItem("token");

/* ===============================
   STATE
=============================== */
let syncing = false;
let scanSeq = Number(localStorage.getItem("scanSeq") || 1);

/* ===============================
   STORAGE
=============================== */
function loadScans() {
  return JSON.parse(localStorage.getItem("offlineScans") || "[]");
}
function saveScans(scans) {
  localStorage.setItem("offlineScans", JSON.stringify(scans));
  localStorage.setItem("scanSeq", scanSeq);
}

/* ===============================
   UI
=============================== */
function addLog(code) {
  const div = document.createElement("div");
  div.className = "log-item";
  div.id = "log_" + code + "_" + Date.now();
  div.innerHTML = `<b>${code}</b> <span class="pending">pending</span>`;
  document.getElementById("log").prepend(div);
  return div.id;
}

function updateLog(id) {
  const el = document.getElementById(id);
  if (el) {
    el.querySelector("span").className = "synced";
    el.querySelector("span").innerText = "synced";
  }
}

/* ===============================
   SUBMIT
=============================== */
function submitScan() {
  const input = document.getElementById("scanInput");
  const code = input.value.trim();
  if (!code) return;

  input.value = "";
  input.focus();

  const logId = addLog(code);

  const scans = loadScans();
  scans.push({
    code,
    seq: scanSeq++,
    sent: false,
    logId
  });
  saveScans(scans);

  processQueue();
}

/* ===============================
   SYNC QUEUE (ORDER SAFE)
=============================== */
async function processQueue() {
  if (syncing) return;
  syncing = true;

  let scans = loadScans();
  scans.sort((a, b) => a.seq - b.seq);

  for (const scan of scans) {
    if (scan.sent) continue;

    try {
      document.getElementById("online").style.display = "block";
      document.getElementById("offline").style.display = "none";

      const res = await fetch(
        `${SCRIPT_URL}?scanData=${encodeURIComponent(scan.code)}&token=${tokenValue}`,
        { cache: "no-store", mode: "cors" }
      );

      if (!res.ok) throw new Error();

      scan.sent = true;
      saveScans(scans);
      updateLog(scan.logId);

      // ðŸ”¥ keep strict order
      await new Promise(r => setTimeout(r, 200));

    } catch {
      document.getElementById("online").style.display = "none";
      document.getElementById("offline").style.display = "block";
      break;
    }
  }

  syncing = false;
}

/* ===============================
   AUTO RESUME
=============================== */
setInterval(processQueue, 3000);

/* ===============================
   ENTER KEY
=============================== */
document.getElementById("scanInput").addEventListener("keydown", e => {
  if (e.key === "Enter") submitScan();
});
</script>

</body>
</html>
