<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>QR Scanner</title>

<style>
body {
  font-family: Arial, sans-serif;
  background: #111;
  color: #fff;
  margin: 0;
  padding: 20px;
}
.container {
  max-width: 800px;
  margin: auto;
  background: #1e1e1e;
  padding: 20px;
  border-radius: 12px;
}
h1 {
  text-align: center;
}
input {
  width: 100%;
  padding: 18px;
  font-size: 18px;
  border-radius: 8px;
  border: none;
  outline: none;
}
button {
  margin-top: 15px;
  width: 100%;
  padding: 18px;
  font-size: 18px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  background: #4caf50;
  color: #000;
  font-weight: bold;
}
.log {
  margin-top: 25px;
  max-height: 400px;
  overflow-y: auto;
}
.log-item {
  background: #2a2a2a;
  margin-bottom: 10px;
  padding: 10px;
  border-radius: 6px;
}
.pending {
  color: #ffc107;
}
.synced {
  color: #4caf50;
}
.offline {
  background: #c62828;
  padding: 8px;
  text-align: center;
  border-radius: 6px;
  display: none;
}
.online {
  background: #2e7d32;
  padding: 8px;
  text-align: center;
  border-radius: 6px;
  display: none;
}
</style>
</head>

<body>

<div class="offline" id="offline">OFFLINE â€” scans saved</div>
<div class="online" id="online">ONLINE â€” syncing</div>

<div class="container">
  <h1>QR Scanner</h1>

  <input id="scanInput" placeholder="Scan code here" autofocus>
  <button onclick="submitScan()">Submit</button>

  <div class="log" id="log"></div>
</div>

<script>
/* ===============================
   CONFIG
=============================== */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyrScJh7k84wwIpEAr4MqSrnsyvPBMp3BYhPpM1hPyG_V7RPBPtQ_um3YYcCw0JLmc/exec";
const tokenValue = localStorage.getItem("token");

/* ===============================
   STATE
=============================== */
let syncing = false;

/* ===============================
   HELPERS
=============================== */
function loadScans() {
  return JSON.parse(localStorage.getItem("offlineScans") || "[]");
}
function saveScans(scans) {
  localStorage.setItem("offlineScans", JSON.stringify(scans));
}
function show(id) {
  document.getElementById(id).style.display = "block";
}
function hide(id) {
  document.getElementById(id).style.display = "none";
}

/* ===============================
   LOG UI
=============================== */
function addLog(code, status) {
  const div = document.createElement("div");
  div.className = "log-item";
  div.id = "log_" + code;
  div.innerHTML = `
    <b>${code}</b>
    <span class="${status}">${status}</span>
  `;
  document.getElementById("log").prepend(div);
}

function updateLog(code, status) {
  const el = document.getElementById("log_" + code);
  if (el) {
    el.querySelector("span").className = status;
    el.querySelector("span").innerText = status;
  }
}

/* ===============================
   CORE LOGIC
=============================== */
function submitScan() {
  const input = document.getElementById("scanInput");
  const code = input.value.trim();
  if (!code) return;

  input.value = "";
  input.focus();

  const scans = loadScans();
  scans.push({
    code,
    sent: false,
    time: Date.now()
  });
  saveScans(scans);

  addLog(code, "pending");
  processQueue();
}

async function processQueue() {
  if (syncing) return;
  syncing = true;

  let scans = loadScans();

  for (let i = 0; i < scans.length; i++) {
    if (scans[i].sent) continue;

    try {
      show("online");
      hide("offline");

      const res = await fetch(
        `${SCRIPT_URL}?scanData=${encodeURIComponent(scans[i].code)}&token=${tokenValue}`,
        { cache: "no-store", mode: "cors" }
      );

      if (!res.ok) throw new Error();

      scans[i].sent = true;
      saveScans(scans);
      updateLog(scans[i].code, "synced");

      // ðŸ”¥ VERY IMPORTANT â€” keep order
      await new Promise(r => setTimeout(r, 200));

    } catch {
      hide("online");
      show("offline");
      break;
    }
  }

  syncing = false;
}

/* ===============================
   AUTO SYNC WHEN ONLINE
=============================== */
setInterval(processQueue, 3000);

/* ===============================
   ENTER KEY SUPPORT
=============================== */
document.getElementById("scanInput").addEventListener("keydown", e => {
  if (e.key === "Enter") submitScan();
});
</script>

</body>
</html>
